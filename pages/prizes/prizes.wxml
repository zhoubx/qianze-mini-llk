<view class="container">
  <!-- 音乐控制组件 -->
  <music-control id="musicControl"></music-control>

  <!-- 用户信息卡片 -->
  <view class="user-card">
    <view class="user-info-display" wx:if="{{!isEditingProfile}}">
      <image class="user-avatar" src="{{userInfo.avatarUrl || defaultAvatarUrl}}" mode="aspectFill"></image>
      <view class="user-details">
        <text class="user-name">{{userInfo.nickName || '未设置昵称'}}</text>
        <text class="user-tip">点击右侧按钮修改头像和昵称</text>
      </view>
      <button class="edit-btn" bindtap="startEditProfile">✏️ 修改</button>
    </view>

    <!-- 编辑模式 -->
    <view class="user-info-edit" wx:if="{{isEditingProfile}}">
      <view class="edit-row">
        <text class="edit-label">头像</text>
        <button class="avatar-picker" open-type="chooseAvatar" bind:chooseavatar="onChooseAvatar">
          <image class="edit-avatar" src="{{userInfo.avatarUrl || defaultAvatarUrl}}" mode="aspectFill"></image>
          <text class="avatar-tip">点击更换</text>
        </button>
      </view>
      <view class="edit-row">
        <text class="edit-label">昵称</text>
        <input 
          type="nickname" 
          class="nickname-input" 
          placeholder="请输入昵称" 
          value="{{userInfo.nickName}}"
          bindinput="onNickNameInput"
          maxlength="20"
        />
      </view>
      <view class="edit-actions">
        <button class="cancel-btn" bindtap="cancelEditProfile">取消</button>
        <button class="save-btn" bindtap="saveUserInfo">保存</button>
      </view>
    </view>
  </view>

  <!-- 页面标题栏 -->
  <view class="page-header">
    <view class="header-main">
      <view class="header-icon">🎁</view>
      <view class="header-title">我的奖品</view>
    </view>
    <view class="header-subtitle">
      <text>系统只会保留您游戏中领取到的最高奖项，核销使用后可再次领取。</text>
      <text>邀请好友一起玩游戏，还可额外获得奖励！</text>
    </view>
  </view>

  <view class="list">
    <view wx:if="{{prizes.length===0 && !loading}}" class="empty">暂无奖品记录，快去玩游戏赢取吧！</view>
    
    <view class="card {{item.status}}" wx:for="{{prizes}}" wx:key="objectId">
      <view class="card-left">
        <view class="row-top">
          <text class="prize-name">{{item.prizeName}}</text>
        </view>
        
        <view class="row-detail">
          <text class="tag">{{item.diffText}}</text>
          <text class="divider">|</text>
          <text class="tag">{{item.timeCost}}s</text>
          <text class="divider">|</text>
          <text class="tag">{{item.rankText}}</text>
          <text class="divider">|</text>
          <text class="score">{{item.score}}分</text>
        </view>

        <view class="row-time">
          <text>过关时间：{{item.createTimeStr}}</text>
        </view>
      </view>

      <view class="card-right">
        <block wx:if="{{item.status === 'pending'}}" >
           <button class="use-btn" bindtap="usePrize" data-id="{{item.objectId}}">核销</button>
        </block>
        <block wx:else>
           <view class="status-info">
             <text class="status-text">{{item.statusText}}</text>
             <view wx:if="{{item.status === 'used'}}" class="redemption-time">
               {{item.redeemedTime ? item.redeemedTimeStr : '暂无时间记录'}}
             </view>
           </view>
        </block>
      </view>
    </view>
  </view>
</view>
