<view class="container">
  <!-- éŸ³ä¹æ§åˆ¶ç»„ä»¶ -->
  <music-control id="musicControl"></music-control>

  <!-- é¡µé¢æ ‡é¢˜æ ï¼ˆæœ€å¤–å±‚ï¼‰ -->
  <view class="page-header">
    <view class="header-main">
      <text class="header-icon">ğŸ</text>
      <text class="header-title">æˆ‘çš„å¥–å“</text>
    </view>
    <view class="header-tips">
      <view class="tip-item">
        <text class="tip-dot">â€¢</text>
        <text class="tip-text">ç³»ç»Ÿåªä¿ç•™æ‚¨æ¸¸æˆä¸­é¢†å–åˆ°çš„æœ€é«˜å¥–é¡¹ï¼Œæ ¸é”€åå¯å†æ¬¡é¢†å–</text>
      </view>
      <view class="tip-item tip-highlight">
        <text class="tip-dot">â€¢</text>
        <text class="tip-text">é‚€è¯·å¥½å‹ä¸€èµ·ç©æ¸¸æˆï¼Œè¿˜å¯é¢å¤–è·å¾—å¥–åŠ±ï¼</text>
      </view>
    </view>
  </view>

  <!-- å¤§å¡ç‰‡å®¹å™¨ï¼šåŒ…è£¹ä¸ªäººä¿¡æ¯å’Œå¥–å“åˆ—è¡¨ -->
  <view class="main-wrapper">
    <!-- ä¸ªäººä¿¡æ¯æ¨¡å— -->
    <view class="profile-section">
      <!-- å±•ç¤ºæ¨¡å¼ -->
      <view class="profile-display" wx:if="{{!isEditingProfile}}">
        <image class="profile-avatar" src="{{userInfo.avatarUrl || defaultAvatarUrl}}" mode="aspectFill"></image>
        <view class="profile-details">
          <text class="profile-name">{{userInfo.nickName || 'æœªè®¾ç½®æ˜µç§°'}}</text>
          <text class="profile-hint">ä¿®æ”¹å°†åŒæ­¥åˆ°æ’è¡Œæ¦œ</text>
        </view>
        <button class="profile-edit-btn" bindtap="startEditProfile">ä¿®æ”¹</button>
      </view>

      <!-- ç¼–è¾‘æ¨¡å¼ -->
      <view class="profile-edit" wx:if="{{isEditingProfile}}">
        <view class="edit-row">
          <button class="avatar-btn" open-type="chooseAvatar" bind:chooseavatar="onChooseAvatar">
            <image class="avatar-preview" src="{{editingAvatarUrl || defaultAvatarUrl}}" mode="aspectFill"></image>
            <text class="avatar-tip">ç‚¹å‡»æ¢å¤´åƒ</text>
          </button>
          <input 
            type="nickname" 
            class="field-input" 
            placeholder="è¯·è¾“å…¥æ˜µç§°" 
            value="{{editingNickName}}"
            bindinput="onNickNameInput"
            maxlength="20"
          />
        </view>
        <view class="edit-actions">
          <button class="btn-cancel" bindtap="cancelEditProfile">å–æ¶ˆ</button>
          <button class="btn-save" bindtap="saveUserInfo">ä¿å­˜</button>
        </view>
      </view>
    </view>

    <!-- åˆ†å‰²çº¿ -->
    <view class="section-divider"></view>

    <!-- åˆ†äº«ä»£é‡‘åˆ¸åˆ—è¡¨ -->
    <view class="section-header" wx:if="{{shareCoupons.length > 0}}">
      <text class="section-icon">ğŸ‰</text>
      <text class="section-title">åˆ†äº«å¥–åŠ±</text>
      <text class="section-subtitle">é‚€è¯·å¥½å‹è·å¾—</text>
    </view>
    <view class="list share-list" wx:if="{{shareCoupons.length > 0}}">
      <view class="card share-card {{item.status}}" wx:for="{{shareCoupons}}" wx:key="_id">
        <view class="card-left">
          <view class="row-top">
            <text class="prize-name share-prize-name">{{item.amount}}å…ƒä»£é‡‘åˆ¸</text>
            <text class="share-badge">åˆ†äº«å¥–åŠ±</text>
          </view>
          
          <view class="row-time">
            <text>è·å¾—æ—¶é—´ï¼š{{item.createTimeStr}}</text>
          </view>
        </view>

        <view class="card-right">
          <block wx:if="{{item.status === 'pending'}}">
             <button class="use-btn share-use-btn" bindtap="useShareCoupon" data-id="{{item._id}}">æ ¸é”€</button>
          </block>
          <block wx:else>
             <view class="status-info">
               <text class="status-text">{{item.statusText}}</text>
               <view wx:if="{{item.status === 'used'}}" class="redemption-time">
                 {{item.redeemedTime ? item.redeemedTimeStr : 'æš‚æ— æ—¶é—´è®°å½•'}}
               </view>
             </view>
          </block>
        </view>
      </view>
    </view>

    <!-- æ¸¸æˆå¥–å“åˆ—è¡¨ -->
    <view class="section-header" wx:if="{{prizes.length > 0}}">
      <text class="section-icon">ğŸ†</text>
      <text class="section-title">æ¸¸æˆå¥–åŠ±</text>
      <text class="section-subtitle">æŒ‘æˆ˜è·å¾—</text>
    </view>

    <view wx:if="{{prizes.length===0 && !loading}}" class="empty">
      <text>æš‚æ— å¥–å“è®°å½•ï¼Œå¿«å»</text>
      <navigator url="/pages/index/index" open-type="redirect" class="empty-link">ç©æ¸¸æˆèµ¢å–</navigator>
      <text>å§ï¼</text>
    </view>

    <view class="list game-list">
      <view class="card game-card {{item.status}}" wx:for="{{prizes}}" wx:key="_id">
        <view class="card-left">
          <view class="row-top">
            <text class="prize-name">{{item.prizeName}}</text>
          </view>
          
          <view class="row-detail">
            <text class="tag">{{item.diffText}}</text>
            <text class="divider">|</text>
            <text class="tag">{{item.timeCost}}s</text>
            <text class="divider">|</text>
            <text class="tag">{{item.rankText}}</text>
            <text class="divider">|</text>
            <text class="score">{{item.score}}åˆ†</text>
          </view>

          <view class="row-time">
            <text>è¿‡å…³æ—¶é—´ï¼š{{item.createTimeStr}}</text>
          </view>
        </view>

        <view class="card-right">
          <block wx:if="{{item.status === 'pending'}}" >
             <button class="use-btn game-use-btn" bindtap="usePrize" data-id="{{item._id}}">æ ¸é”€</button>
          </block>
          <block wx:else>
             <view class="status-info">
               <text class="status-text">{{item.statusText}}</text>
               <view wx:if="{{item.status === 'used'}}" class="redemption-time">
                 {{item.redeemedTime ? item.redeemedTimeStr : 'æš‚æ— æ—¶é—´è®°å½•'}}
               </view>
             </view>
          </block>
        </view>
      </view>
    </view>
  </view>
</view>
