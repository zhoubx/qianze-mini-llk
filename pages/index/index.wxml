<view class="container {{isGameActive ? 'game-mode' : ''}}">

  <view class="header">
    <view class="banner-box">
      <image class="header-banner" src="/images/header-banner.png" mode="widthFix"></image>
    </view>
  </view>

  <!-- éŸ³ä¹æ§åˆ¶ç»„ä»¶ -->
  <music-control id="musicControl"></music-control>

  <!-- å† å†›åº†ç¥åŠ¨ç”» -->
  <champion-celebration id="championCelebration"></champion-celebration>

  <view class="top-actions" wx:if="{{!isGameActive}}">
    <navigator url="/pages/rules/rules" class="action-link">ğŸ“– æ¸¸æˆè§„åˆ™</navigator>
    <navigator url="/pages/prizes/prizes" class="action-link">ğŸ æˆ‘çš„å¥–å“</navigator>
    <view bindtap="visitStore" class="action-link">ğŸ›ï¸ è¿›åº—çœ‹çœ‹</view>
  </view>

  <view class="menu-screen" wx:if="{{!isGameActive}}">
    <view class="difficulty-card {{item.class}}" wx:for="{{diffConfig}}" wx:key="id" bindtap="startGame" data-diff="{{item.id}}">
      <view class="diff-info">
        <view class="diff-header">
          <text class="diff-title">{{item.title}}</text>
          <text class="diff-badge {{item.badgeClass}}">{{item.badge}}</text>
          <text class="diff-multiplier {{item.badgeClass}}">x{{item.multiplier}}</text>
        </view>
        <text class="diff-desc">{{item.desc}}</text>
      </view>
      <view style="font-size:48rpx">{{item.icon}}</view>
    </view>

    <view class="leaderboard-box">
      <view class="lb-header">
        <text class="lb-title">ğŸ‘‘ å…¨æœé£äº‘æ¦œï¼ˆ72å°æ—¶æ“‚å°èµ›ï¼‰</text>
        <view class="lb-refresh-wrapper">
          <text class="lb-timer" bindtap="fetchLeaderboard">ğŸ”„ åˆ·æ–°</text>
          <text class="lb-loading-icon {{isRefreshing ? 'rotating' : ''}}" wx:if="{{isRefreshing}}">â³</text>
        </view>
      </view>
      <scroll-view scroll-y class="lb-list">
        <view wx:if="{{rankList.length === 0}}" style="text-align:center;color:#999;margin-top:50rpx;font-size:24rpx">æš‚æ— æ•°æ®ï¼Œå¿«æ¥æŠ¢å æ¦œé¦–ï¼</view>
        <view class="lb-item" wx:for="{{rankList}}" wx:key="objectId">
          <text class="lb-rank rank-{{index+1}}">{{index + 1}}</text>
          <view class="lb-info">
            <view class="lb-name-row">
              <image class="lb-avatar" src="{{item.avatarUrl || defaultAvatarUrl}}" mode="aspectFill"></image>
              <text class="lb-name">{{item.playerName}}</text>
            </view>
            <text class="lb-time-row">{{item.createTimeStr}} Â· {{item.diffText || 'æœªçŸ¥'}} Â· è€—æ—¶ {{item.timeCost}}s</text>
          </view>
          <view class="lb-prize-col">
            <view class="lb-prize-tag">ğŸ {{item.prizeName}}</view>
          </view>
          <text class="lb-score">{{item.score}}</text>
        </view>
      </scroll-view>
    </view>
  </view>

  <view class="game-screen" wx:if="{{isGameActive}}">
    <view class="status-bar">
      <text>â±ï¸ {{timeDisplay}}s</text>
      <text>â­ {{liveScore}}</text>
    </view>

    <view class="game-board" style="grid-template-columns: repeat({{cols}}, 1fr);">
      <view wx:for="{{domTiles}}" wx:key="id" 
            class="tile {{item.selected ? 'selected' : ''}} {{item.matched ? 'matched' : ''}} {{item.isPath ? 'path-highlight' : ''}}"
            style="background-image: url('{{item.img}}'); width:{{tileSize}}; height:{{tileSize}};"
            bindtap="handleTileClick" data-r="{{item.r}}" data-c="{{item.c}}">
      </view>
    </view>

    <!-- æ´—ç‰Œå¥–åŠ±æç¤ºï¼ˆæ”¾åœ¨æ¸¸æˆçª—å£ä¸‹æ–¹ï¼‰ -->
    <view class="shuffle-toast {{shuffleToastVisible ? 'visible' : ''}}" wx:if="{{shuffleToastText}}">
      <text class="shuffle-icon">ğŸ”„</text>
      <text class="shuffle-text">{{shuffleToastText}}</text>
    </view>
    
    <button style="background:transparent; color:#888; font-size:28rpx; margin-top:20rpx;" bindtap="backToMenu">æ”¾å¼ƒæŒ‘æˆ˜</button>
  </view>

  <view class="modal-overlay" wx:if="{{showModal}}">
    <view class="modal">
      <view class="win-header">æŒ‘æˆ˜æˆåŠŸ!</view>
      <view class="prize-alert">
        <view class="score-display">
          <view class="score-value">{{tempScore}} åˆ†</view>
          <view class="score-tip" wx:if="{{scoreBreakthrough}}">{{scoreBreakthrough}}</view>
        </view>
        <view class="prize-rank">æœ¬æ¬¡æ’å: ç¬¬ <text style="font-weight:bold;">{{myRank}}</text> å</view>
        <view class="prize-name">{{finalPrizeName}}</view>
      </view>
      <text class="input-label">è¯·è®¾ç½®æ‚¨çš„å¤´åƒ/æ˜µç§°ï¼ˆç”¨äºæ’è¡Œæ¦œå±•ç¤ºå’Œé¢†å¥–æ ¸é”€ï¼‰</text>

      <view style="display:flex; align-items:center; justify-content:center; margin-bottom: 20rpx;">
        <!-- å¤´åƒé€‰æ‹© -->
        <button class="avatar-wrapper" open-type="chooseAvatar" bind:chooseavatar="onChooseAvatar" style="margin-bottom:0; margin-right:20rpx;">
          <image class="avatar" src="{{avatarUrl}}"></image>
        </button>
        <!-- æ˜µç§°è¾“å…¥ -->
        <view class="nickname-section" style="flex:1;">
          <input
            type="nickname"
            class="name-input"
            placeholder="è¯·è¾“å…¥æ‚¨çš„æ˜µç§°"
            value="{{inputName}}"
            bindinput="onNameInput"
            maxlength="30"
            style="margin-bottom:0;"/>
        </view>
      </view>
   
      <button class="btn-primary" loading="{{submitting}}" bindtap="submitScore">ç¡®è®¤é¢†å–å¹¶ä¸Šæ¦œ</button>
      <button style="font-size:24rpx; color:#666; background:transparent;" open-type="share">ğŸ‰ ç‚«è€€æˆ˜ç»©</button>
    </view>
  </view>

  <!-- æäº¤æˆåŠŸåçš„é€‰æ‹©å¼¹çª— -->
  <view class="modal-overlay" wx:if="{{showPostSubmitModal}}">
    <view class="modal post-submit-modal">
      <view class="win-header">ğŸ‰ æäº¤æˆåŠŸï¼</view>
      <view class="prize-alert">
        <view class="prize-name">æ‚¨å¯ä»¥é€‰æ‹©æ¥ä¸‹æ¥çš„æ“ä½œï¼š</view>
      </view>

      <view class="action-buttons">
        <button class="action-btn continue-btn" bindtap="continueChallenge">ğŸ® ç»§ç»­æŒ‘æˆ˜</button>
        <button class="action-btn leaderboard-btn" bindtap="viewLeaderboard">ğŸ† æŸ¥çœ‹æ’è¡Œæ¦œ</button>
        <button class="action-btn invite-btn" open-type="share">ğŸ é‚€è¯·å¥½å‹ï¼ˆå†å¾—5å…ƒåˆ¸ï¼‰</button>
        <button class="action-btn store-btn" bindtap="visitStore">ğŸª è¿›åº—çœ‹çœ‹</button>
      </view>

      <button class="close-btn" bindtap="closePostSubmitModal">å…³é—­</button>
    </view>
  </view>
  
</view>