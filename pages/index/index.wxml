<view class="container">
  <view class="header">
    <text class="title">芊泽养生 SPA</text>
    <text class="slogan">凭实力赢优惠券，身心愉悦两不误！</text>
  </view>

  <!-- 音乐控制组件 -->
  <music-control id="musicControl"></music-control>

  <!-- 冠军庆祝动画 -->
  <champion-celebration id="championCelebration"></champion-celebration>

  <view class="top-actions" wx:if="{{!isGameActive}}">
    <navigator url="/pages/rules/rules" class="action-link">📖 游戏规则</navigator>
    <navigator url="/pages/prizes/prizes" class="action-link">🎁 我的奖品</navigator>
  </view>

  <view class="menu-screen" wx:if="{{!isGameActive}}">
    <view class="difficulty-card {{item.class}}" wx:for="{{diffConfig}}" wx:key="id" bindtap="startGame" data-diff="{{item.id}}">
      <view class="diff-info">
        <view class="diff-header">
          <text class="diff-title">{{item.title}}</text>
          <text class="diff-badge {{item.badgeClass}}">{{item.badge}}</text>
          <text class="diff-multiplier {{item.badgeClass}}">x{{item.multiplier}}</text>
        </view>
        <text class="diff-desc">{{item.desc}}</text>
      </view>
      <view style="font-size:48rpx">{{item.icon}}</view>
    </view>

    <view class="leaderboard-box">
      <view class="lb-header">
        <text class="lb-title">👑 全服风云榜（72小时擂台赛）</text>
        <view class="lb-refresh-wrapper">
          <text class="lb-timer" bindtap="fetchLeaderboard">🔄 刷新</text>
          <text class="lb-loading-icon {{isRefreshing ? 'rotating' : ''}}" wx:if="{{isRefreshing}}">⏳</text>
        </view>
      </view>
      <scroll-view scroll-y class="lb-list">
        <view wx:if="{{rankList.length === 0}}" style="text-align:center;color:#999;margin-top:50rpx;font-size:24rpx">暂无数据，快来抢占榜首！</view>
        <view class="lb-item" wx:for="{{rankList}}" wx:key="objectId">
          <text class="lb-rank rank-{{index+1}}">{{index + 1}}</text>
          <view class="lb-info">
            <view class="lb-name-row">
              <image class="lb-avatar" src="{{item.avatarUrl || defaultAvatarUrl}}" mode="aspectFill"></image>
              <text class="lb-name">{{item.playerName}}</text>
            </view>
            <text class="lb-time-row">{{item.createTimeStr}} · {{item.diffText || '未知'}} · 耗时 {{item.timeCost}}s</text>
          </view>
          <view class="lb-prize-col">
            <view class="lb-prize-tag">🎁 {{item.prizeName}}</view>
          </view>
          <text class="lb-score">{{item.score}}</text>
        </view>
      </scroll-view>
    </view>
  </view>

  <view class="game-screen" wx:if="{{isGameActive}}">
    <view class="status-bar">
      <text>⏱️ {{timeDisplay}}s</text>
      <text>⭐ {{liveScore}}</text>
    </view>

    <view class="game-board" style="grid-template-columns: repeat({{cols}}, 1fr);">
      <view wx:for="{{domTiles}}" wx:key="id" 
            class="tile {{item.selected ? 'selected' : ''}} {{item.matched ? 'matched' : ''}} {{item.isPath ? 'path-highlight' : ''}}"
            style="background-image: url('{{item.img}}'); width:{{tileSize}}; height:{{tileSize}};"
            bindtap="handleTileClick" data-r="{{item.r}}" data-c="{{item.c}}">
      </view>
    </view>

    <!-- 洗牌奖励提示（放在游戏窗口下方） -->
    <view class="shuffle-toast {{shuffleToastVisible ? 'visible' : ''}}" wx:if="{{shuffleToastText}}">
      <text class="shuffle-icon">🔄</text>
      <text class="shuffle-text">{{shuffleToastText}}</text>
    </view>
    
    <button style="background:transparent; color:#888; font-size:28rpx; margin-top:20rpx;" bindtap="backToMenu">放弃挑战</button>
  </view>

  <view class="modal-overlay" wx:if="{{showModal}}">
    <view class="modal">
      <view class="win-header">挑战成功!</view>
      <view class="prize-alert">
        <view class="score-display">
          <view class="score-value">{{tempScore}} 分</view>
          <view class="score-tip" wx:if="{{scoreBreakthrough}}">{{scoreBreakthrough}}</view>
        </view>
        <view class="prize-rank">本次排名: 第 <text style="font-weight:bold;">{{myRank}}</text> 名</view>
        <view class="prize-name">{{finalPrizeName}}</view>
      </view>
      <text class="input-label">请设置您的头像/昵称（用于排行榜展示和领奖核销）</text>

      <view style="display:flex; align-items:center; justify-content:center; margin-bottom: 20rpx;">
        <!-- 头像选择 -->
        <button class="avatar-wrapper" open-type="chooseAvatar" bind:chooseavatar="onChooseAvatar" style="margin-bottom:0; margin-right:20rpx;">
          <image class="avatar" src="{{avatarUrl}}"></image>
        </button>
        <!-- 昵称输入 -->
        <view class="nickname-section" style="flex:1;">
          <input
            type="nickname"
            class="name-input"
            placeholder="请输入您的昵称"
            value="{{inputName}}"
            bindinput="onNameInput"
            maxlength="30"
            style="margin-bottom:0;"/>
        </view>
      </view>
   
      <button class="btn-primary" loading="{{submitting}}" bindtap="submitScore">确认领取并上榜</button>
      <button style="font-size:24rpx; color:#666; background:transparent;" open-type="share">🎉 炫耀战绩</button>
    </view>
  </view>

  <!-- 提交成功后的选择弹窗 -->
  <view class="modal-overlay" wx:if="{{showPostSubmitModal}}">
    <view class="modal post-submit-modal">
      <view class="win-header">🎉 提交成功！</view>
      <view class="prize-alert">
        <view class="prize-name">您可以选择接下来的操作：</view>
      </view>

      <view class="action-buttons">
        <button class="action-btn continue-btn" bindtap="continueChallenge">🎮 继续挑战</button>
        <button class="action-btn leaderboard-btn" bindtap="viewLeaderboard">🏆 查看排行榜</button>
        <button class="action-btn invite-btn" open-type="share">🎁 邀请好友（再得5元券）</button>
        <button class="action-btn store-btn" bindtap="visitStore">🏪 进店看看</button>
      </view>

      <button class="close-btn" bindtap="closePostSubmitModal">关闭</button>
    </view>
  </view>
  
</view>