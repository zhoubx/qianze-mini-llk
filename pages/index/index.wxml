<view class="container {{isGameActive ? 'game-mode' : ''}}">

  <view class="header">
    <view class="banner-box">
      <image class="header-banner" src="/images/header-banner.png" mode="widthFix"></image>
    </view>
  </view>

  <!-- 音乐控制组件 -->
  <music-control id="musicControl"></music-control>

  <!-- 冠军庆祝动画 -->
  <champion-celebration id="championCelebration"></champion-celebration>

  <view class="top-actions" wx:if="{{!isGameActive}}">
    <navigator url="/pages/rules/rules" class="action-link">📖 游戏规则</navigator>
    <navigator url="/pages/prizes/prizes" class="action-link">🎁 我的奖品</navigator>
    <view bindtap="visitStore" class="action-link">🛍️ 进店看看</view>
  </view>

  <view class="menu-screen" wx:if="{{!isGameActive}}">
    <view class="difficulty-card {{item.class}}" wx:for="{{diffConfig}}" wx:key="id" bindtap="startGame" data-diff="{{item.id}}">
      <view class="diff-info">
        <view class="diff-header">
          <text class="diff-title">{{item.title}}</text>
          <text class="diff-badge {{item.badgeClass}}">{{item.badge}}</text>
          <text class="diff-multiplier {{item.badgeClass}}">x{{item.multiplier}}</text>
        </view>
        <text class="diff-desc">{{item.desc}}</text>
      </view>
      <view style="font-size:58rpx">{{item.icon}}</view>
    </view>

    <view class="leaderboard-box">
      <view class="lb-header">
        <text class="lb-title">👑 全服风云榜 (72小时擂台赛)</text>
        <view class="lb-refresh-wrapper">
          <text class="lb-timer" bindtap="fetchLeaderboard">🔄 刷新</text>
          <text class="lb-loading-icon {{isRefreshing ? 'rotating' : ''}}" wx:if="{{isRefreshing}}">⏳</text>
        </view>
      </view>
      <scroll-view scroll-y class="lb-list">
        <view wx:if="{{rankList.length === 0}}" style="text-align:center;color:#999;margin-top:50rpx;font-size:24rpx">暂无数据，快来抢占榜首！</view>
        <view class="lb-item" wx:for="{{rankList}}" wx:key="objectId">
          <text class="lb-rank rank-{{index+1}}">{{index + 1}}</text>
          <view class="lb-info">
            <view class="lb-name-row">
              <image class="lb-avatar" src="{{item.avatarUrl || defaultAvatarUrl}}" mode="aspectFill"></image>
              <text class="lb-name">{{item.playerName}}</text>
            </view>
            <text class="lb-time-row">{{item.createTimeStr}} · {{item.diffText || '未知'}} · 耗时 {{item.timeCost}}s</text>
          </view>
          <view class="lb-prize-col">
            <view class="lb-prize-tag">🎁 {{item.prizeName}}</view>
          </view>
          <text class="lb-score">{{item.score}}</text>
        </view>
      </scroll-view>
    </view>
  </view>

  <view class="game-screen" wx:if="{{isGameActive}}">
    <view class="status-bar">
      <text>⏱️ {{timeDisplay}}s</text>
      <text>⭐ {{liveScore}}</text>
    </view>

    <view class="game-board" style="grid-template-columns: repeat({{cols}}, 1fr);">
      <view wx:for="{{domTiles}}" wx:key="id" 
            class="tile {{item.selected ? 'selected' : ''}} {{item.matched ? 'matched' : ''}} {{item.isPath ? 'path-highlight' : ''}}"
            style="width:{{tileSize}}; height:{{tileSize}};"
            bindtap="handleTileClick" data-r="{{item.r}}" data-c="{{item.c}}">
        <image class="tile-img" src="{{item.img}}" mode="aspectFill" />
      </view>
    </view>

    <!-- 洗牌奖励提示（放在游戏窗口下方） -->
    <view class="shuffle-toast {{shuffleToastVisible ? 'visible' : ''}}" wx:if="{{shuffleToastText}}">
      <text class="shuffle-icon">🔄</text>
      <text class="shuffle-text">{{shuffleToastText}}</text>
    </view>
    
    <button style="background:transparent; color:#888; font-size:28rpx; margin-top:20rpx;" bindtap="backToMenu">放弃挑战</button>
  </view>

  <view class="modal-overlay" wx:if="{{showModal}}">
    <view class="modal">
      <view class="win-header">挑战成功!</view>
      <view class="prize-alert">
        <view class="score-display">
          <view class="score-value">{{tempScore}} 分</view>
          <view class="score-tip" wx:if="{{scoreBreakthrough}}">{{scoreBreakthrough}}</view>
        </view>
        <view class="prize-rank">本次排名: 第 <text style="font-weight:bold;">{{myRank}}</text> 名</view>
        <view class="prize-name">{{finalPrizeName}}</view>
      <text class="prize-beizhu">系统只会保留您在游戏中领取到的最高奖项</text>
      </view>
      <text class="input-label">请设置您的头像/昵称（用于排行榜展示和领奖核销）</text>

      <view style="display:flex; align-items:center; justify-content:center; margin-bottom: 20rpx;">
        <!-- 头像选择 -->
        <button class="avatar-wrapper" open-type="chooseAvatar" bind:chooseavatar="onChooseAvatar" style="margin-bottom:0; margin-right:20rpx;">
          <view class="avatar-container">
            <image wx:if="{{hasCustomAvatar && avatarUrl}}" class="avatar" src="{{avatarUrl}}"></image>
            <view wx:else class="avatar-placeholder">
              <image class="camera-icon" src="/images/camera-icon.png" mode="aspectFit"></image>
            </view>
          </view>
        </button>
        <!-- 昵称输入 -->
        <view class="nickname-section" style="flex:1;">
          <input
            type="nickname"
            class="name-input"
            placeholder="请输入您的昵称"
            value="{{inputName}}"
            bindinput="onNameInput"
            maxlength="30"
            style="margin-bottom:0;"/>
        </view>
      </view>
   
      <button class="btn-primary" loading="{{submitting}}" bindtap="submitScore">确认领取并上榜</button>
      <button class="btn-share-win" open-type="share">
        <view class="btn-share-content">
          <text class="btn-share-icon">🎉</text>
          <view class="btn-share-text">
            <text class="btn-share-label">炫耀战绩</text>
          </view>
        </view>
      </button>
      <text class="btn-share-prize-text">邀请好友即得超值优惠券</text>
    </view>
  </view>

  <!-- 提交成功后的选择弹窗 -->
  <view class="modal-overlay" wx:if="{{showPostSubmitModal}}">
    <view class="modal post-submit-modal">
      <view class="win-header">🎉 提交成功！</view>

      <view class="action-buttons">
        <button class="action-btn continue-btn" bindtap="continueChallenge">
          <text class="btn-icon">🎮</text>
          <text class="btn-text">继续挑战</text>
        </button>
        <button class="action-btn prizes-btn" bindtap="viewPrizes">
          <text class="btn-icon">🎁</text>
          <text class="btn-text">我的奖品</text>
        </button>
        <button class="action-btn invite-btn" open-type="share">
          <text class="btn-icon">🎁</text>
          <text class="btn-text">邀请好友</text>
          <text class="btn-sub">再得5元券</text>
        </button>
        <button class="action-btn store-btn" bindtap="visitStore">
          <text class="btn-icon">🛍️</text>
          <text class="btn-text">进店看看</text>
        </button>
      </view>

      <button class="close-btn" bindtap="closePostSubmitModal">关闭</button>
    </view>
  </view>

  <!-- 分享奖励通知弹窗 -->
  <view class="modal-overlay" wx:if="{{showShareRewardModal}}">
    <view class="modal share-reward-modal">
      <view class="share-reward-header">
        <text class="share-reward-emoji">🎉</text>
        <text class="share-reward-title">恭喜获得分享奖励!</text>
      </view>
      <view class="share-reward-content">
        <view class="share-reward-amount">
          <text class="amount-number">{{newShareCouponAmount}}</text>
          <text class="amount-unit">元</text>
        </view>
        <view class="share-reward-desc">
          您邀请的好友完成了游戏，您获得了 {{newShareCouponCount}} 张代金券！
        </view>
      </view>
      <view class="share-reward-actions">
        <button class="share-reward-btn view-btn" bindtap="goToPrizesFromShareReward">查看奖品</button>
        <button class="share-reward-btn close-btn-secondary" bindtap="closeShareRewardModal">知道了</button>
      </view>
    </view>
  </view>
  
</view>